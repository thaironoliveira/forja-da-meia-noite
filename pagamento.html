<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forja da Meia Noite - Planos</title>
    <link rel="stylesheet" href="pagamento.css">
</head>
<body>
    <div class="container-pagamento">
        <a href="gerador.html" class="voltar-link">&larr; Voltar ao Gerador</a>
        
        <h1>Planos Premium</h1>
        <p class="subtitulo-pagamento">
            Desbloqueie todo o poder da Forja.
        </p>

        <div class="planos-container">
            <div class="plano-box">
                <h2>Iniciado</h2>
                <div class="preco">R$ 7,00<span>Pagamento único</span></div>
                <ul class="beneficios-lista">
                    <li>✅ <strong>1 Crédito</strong> Premium</li>
                    <li>✅ Use na Tabela Quadrada</li>
                    <li>✅ Download em SVG (Vetor)</li>
                </ul>
                <button class="btn-pagar" data-plano-id="plano_1">Comprar 1 Crédito</button>
            </div>

            <div class="plano-box plano-destaque">
                <h2>Aprendiz</h2>
                <div class="preco">R$ 14,00<span>Pagamento único</span></div>
                <ul class="beneficios-lista">
                    <li>✅ <strong>3 Créditos</strong> Premium</li>
                    <li>✅ Use na Tabela Quadrada</li>
                    <li>✅ Download em SVG (Vetor)</li>
                </ul>
                <button class="btn-pagar" data-plano-id="plano_2">Comprar 3 Créditos</button>
            </div>

            <div class="plano-box">
                <h2>Mestre Forjador</h2>
                <div class="preco">R$ 57,00<span>Pagamento único</span></div>
                <ul class="beneficios-lista">
                    <li>✅ <strong>Créditos ILIMITADOS</strong></li>
                    <li>✅ Acesso <strong>vitalício</strong></li>
                    <li>✅ Use na Tabela Quadrada</li>
                    <li>✅ Download em SVG (Vetor)</li>
                </ul>
                <button class="btn-pagar" data-plano-id="plano_3">Tornar-se Mestre</button>
            </div>
        </div>
            
        <p id="msgStatus" class="msg-sucesso"></p>
    </div>

    <script>
        const btnsPagamento = document.querySelectorAll('.btn-pagar');
        const msgStatus = document.getElementById('msgStatus');

        // Pega o e-mail do usuário que foi salvo no Login
        const emailUsuario = localStorage.getItem('usuario_email');

        if (!emailUsuario) {
            msgStatus.style.color = '#FF5555';
            msgStatus.textContent = 'Erro: Usuário não encontrado. Faça login novamente.';
            btnsPagamento.forEach(b => b.disabled = true);
        }

        btnsPagamento.forEach(botao => {
            botao.addEventListener('click', async () => {
                
                const planoId = botao.dataset.planoId;

                // 2. Trava os botões
                btnsPagamento.forEach(b => b.disabled = true);
                msgStatus.style.color = '#D4AF37';
                msgStatus.textContent = 'Conectando ao Mercado Pago...';

                try {
                    // 3. CHAMA O ROBÔ 1 (criar-pagamento.js)
                    const response = await fetch('/.netlify/functions/criar-pagamento', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            email: emailUsuario, 
                            planoId: planoId 
                        })
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.erro || 'Falha ao criar link de pagamento.');
                    }

                    // 4. SUCESSO!
                    msgStatus.textContent = 'Redirecionando para o pagamento...';

                    // 5. Redireciona o usuário para o link de checkout REAL
                    window.location.href = data.link_pagamento;

                } catch (error) {
                    msgStatus.style.color = '#FF5555';
                    msgStatus.textContent = error.message;
                    btnsPagamento.forEach(b => b.disabled = false);
                }
            });
        });
    </script>
</body>
</html>