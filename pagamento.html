<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forja da Meia Noite - Planos</title>
    <link rel="stylesheet" href="pagamento.css">
</head>
<body>
    <div class="container-pagamento">
        <a href="gerador.html" class="voltar-link">&larr; Voltar ao Gerador</a>
        
        <h1>Planos Premium</h1>
        <p class="subtitulo-pagamento">
            Desbloqueie todo o poder da Forja.
        </p>

        <div class="planos-container">

            <div class="plano-box">
                <h2>Iniciado</h2>
                <div class="preco">R$ 7,00<span>Pagamento único</span></div>
                <ul class="beneficios-lista">
                    <li>✅ <strong>1 Crédito</strong> Premium</li>
                    <li>✅ Use na Tabela Quadrada</li>
                    <li>✅ Download em SVG (Vetor)</li>
                </ul>
                <button class="btn-pagar" data-creditos="1">Comprar 1 Crédito (Simulação)</button>
            </div>

            <div class="plano-box plano-destaque">
                <h2>Aprendiz</h2>
                <div class="preco">R$ 14,00<span>Pagamento único</span></div>
                <ul class="beneficios-lista">
                    <li>✅ <strong>3 Créditos</strong> Premium</li>
                    <li>✅ Use na Tabela Quadrada</li>
                    <li>✅ Download em SVG (Vetor)</li>
                </ul>
                <button class="btn-pagar" data-creditos="3">Comprar 3 Créditos (Simulação)</button>
            </div>

            <div class="plano-box">
                <h2>Mestre Forjador</h2>
                <div class="preco">R$ 57,00<span>Pagamento único</span></div>
                <ul class="beneficios-lista">
                    <li>✅ <strong>Créditos ILIMITADOS</strong></li>
                    <li>✅ Acesso <strong>vitalício</strong></li>
                    <li>✅ Use na Tabela Quadrada</li>
                    <li>✅ Download em SVG (Vetor)</li>
                </ul>
                <button class="btn-pagar" data-creditos="999999">Tornar-se Mestre (Simulação)</button>
            </div>

        </div>
            
        <p id="msgStatus" class="msg-sucesso"></p>
    </div>

    <script>
        const btnsPagamento = document.querySelectorAll('.btn-pagar');
        const msgStatus = document.getElementById('msgStatus');

        // Pega o e-mail do usuário que foi salvo no Login
        const emailUsuario = localStorage.getItem('usuario_email');

        if (!emailUsuario) {
            // Se não souber quem é o usuário, não pode comprar
            msgStatus.style.color = '#FF5555';
            msgStatus.textContent = 'Erro: Usuário não encontrado. Faça login novamente.';
            btnsPagamento.forEach(b => b.disabled = true);
        }

        btnsPagamento.forEach(botao => {
            botao.addEventListener('click', async () => {
                
                // 1. Pega os créditos do botão
                const creditosComprados = parseInt(botao.dataset.creditos);

                // 2. Trava os botões
                btnsPagamento.forEach(b => b.disabled = true);
                msgStatus.style.color = '#D4AF37';
                msgStatus.textContent = 'Processando pagamento...';

                /* * No mundo real:
                 * 1. Aqui você redirecionaria para o Mercado Pago.
                 * 2. O Mercado Pago, após o pagamento, chamaria um "Webhook" 
                 * (um "robô" que você ainda não criou, ex: 'processar-webhook.js')
                 * para adicionar os créditos.
                 *
                 * * Na nossa SIMULAÇÃO:
                 * Vamos chamar o robô 'comprar-creditos.js' diretamente,
                 * como se o pagamento já tivesse sido aprovado.
                 */

                try {
                    // 3. CHAMA O ROBÔ DE COMPRA
                    const response = await fetch('/.netlify/functions/comprar-creditos', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            email: emailUsuario, 
                            creditosComprados: creditosComprados 
                        })
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.erro || 'Falha ao adicionar créditos.');
                    }

                    // 4. SUCESSO!
                    // Atualiza o localStorage local com os créditos que o Backend confirmou
                    localStorage.setItem('usuario_creditos', data.creditos);

                    msgStatus.textContent = 'Pagamento aprovado! Redirecionando...';

                    // 5. Redireciona de volta ao gerador
                    setTimeout(() => {
                        window.location.href = 'gerador.html';
                    }, 2000); 

                } catch (error) {
                    msgStatus.style.color = '#FF5555';
                    msgStatus.textContent = error.message;
                    btnsPagamento.forEach(b => b.disabled = false);
                }
            });
        });
    </script>
</body>
</html>